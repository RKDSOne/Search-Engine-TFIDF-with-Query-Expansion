modulcsv local p defaultsettings delimiter quotechar ignoreemptylines true linebreak deviates from rfc4180 where the default linebreak is crlf mediawiki newlines are linebreaks linebreak n datastring is the string containing the csv data settings follows the format of defaultsettings returns a table which is a squence of sequeces of fields function parsedatastring settings if settings nil then settings end if typesettings table then return error settings is not a table end for k v in pairsdefaultsettings do if settingsk nil then settingsk defaultsettingsk end end return readdatadatastring settings end function readdatadatastring settings datastring datastringgsub settings linebreak settings linebreak settings delimiter settings delimiter local itemlist for v in datastringgmatch settings delimiter settings delimiter do table insert itemlist v end local itemlist2 local current local inquote false for v in ipairs itemlist do if not inquote then if vmatch s settings quotechar then inquote true current v else table insert itemlist2 v end else current current settings delimiter v end if inquote then if vmatch settings quotechar s and not currentmatch s settings quotechar s then current currentmatch s settings quotechar settings quotechar s current currentgsub settings linebreak settings delimiter settings linebreak current currentgsub settings quotechar settings quotechar settings quotechar table insert itemlist2 current inquote false current end end end if current then table insert itemlist2 current end local rows itemlist local front for v in ipairsitemlist2 do front vmatch settings linebreak if front nil then if itemlist 0 or frontlen 0 or not settings ignoreemptylines then table insert itemlist front table insert rows itemlist end itemlist else table insert itemlist v end end if itemlist 0 then table insert rows itemlist end return rows end p parse parse return p 